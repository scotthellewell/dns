<div class="page-container">
  <div class="page-header">
    <h1>Cluster Synchronization</h1>
    <p class="subtitle">Configure multi-server synchronization for high availability</p>
  </div>

  <div *ngIf="loading && !config" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Loading configuration...</p>
  </div>

  <mat-card class="content-card" *ngIf="config">
    <div class="card-section">
      <div class="section-header">
        <h2>Enable Synchronization</h2>
      </div>
      
      <div class="toggle-row">
        <div class="toggle-info">
          <h3>Cluster Sync</h3>
          <p>Replicate zones, records, and settings across multiple DNS servers</p>
        </div>
        <mat-slide-toggle [(ngModel)]="configForm.enabled" color="primary"></mat-slide-toggle>
      </div>
    </div>

    <div class="card-section">
      <div class="section-header">
        <h2>Server Identity</h2>
        <p class="section-desc">Identify this server in the cluster</p>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Server Name</mat-label>
        <input matInput [(ngModel)]="configForm.server_name" placeholder="e.g., Primary DNS Server">
        <mat-hint>A friendly name for this server in the cluster</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Server ID</mat-label>
        <input matInput [(ngModel)]="configForm.server_id" placeholder="Auto-generated if empty" class="monospace">
        <mat-hint>Unique identifier for this server (auto-generated if left empty)</mat-hint>
      </mat-form-field>
    </div>

    <div class="card-section">
      <div class="section-header">
        <h2>Security</h2>
        <p class="section-desc">Authentication for peer connections</p>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Shared Secret</mat-label>
        <input matInput [(ngModel)]="configForm.shared_secret" type="password"
               placeholder="Enter shared secret for peer authentication" class="monospace">
        <mat-hint>HMAC secret used to authenticate peer connections (must be same on all servers)</mat-hint>
      </mat-form-field>

      <button mat-stroked-button color="primary" (click)="generateSecret()" class="action-btn">
        <mat-icon>vpn_key</mat-icon>
        Generate New Secret
      </button>
    </div>

    <div class="card-section">
      <div class="section-header">
        <h2>Peer Servers</h2>
        <p class="section-desc">Other DNS servers to synchronize with</p>
      </div>

      <div class="server-list" *ngIf="configForm.peers.length">
        <div class="server-item" *ngFor="let peer of configForm.peers; let i = index">
          <div class="server-info">
            <mat-icon>dns</mat-icon>
            <span class="monospace">{{ peer.url }}</span>
            <span class="badge warning" *ngIf="peer.insecure_skip_verify">insecure</span>
          </div>
          <button mat-icon-button color="warn" (click)="removePeerFromConfig(i)" matTooltip="Remove peer">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>

      <div class="empty-text" *ngIf="!configForm.peers.length">
        No peers configured - this server will operate standalone
      </div>

      <div *ngIf="showAddPeer" class="add-peer-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Peer URL</mat-label>
          <input matInput [(ngModel)]="newPeerUrl" placeholder="wss://peer.example.com:9443/sync">
          <mat-hint>WebSocket URL of the peer server</mat-hint>
        </mat-form-field>

        <mat-checkbox [(ngModel)]="newPeerInsecure" class="checkbox-row">
          Skip TLS verification (for self-signed certificates)
        </mat-checkbox>

        <div class="form-actions">
          <button mat-button (click)="toggleAddPeer()">Cancel</button>
          <button mat-raised-button color="primary" (click)="addPeerToConfig()" [disabled]="!newPeerUrl">
            Add Peer
          </button>
        </div>
      </div>

      <button mat-stroked-button (click)="toggleAddPeer()" *ngIf="!showAddPeer" class="action-btn">
        <mat-icon>add</mat-icon>
        Add Peer Server
      </button>
    </div>

    <div class="card-section">
      <div class="section-header">
        <h2>Advanced Settings</h2>
        <p class="section-desc">Configure sync behavior</p>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Tombstone Retention (days)</mat-label>
        <input matInput type="number" [(ngModel)]="configForm.tombstone_retention_days" min="1" max="365">
        <mat-hint>How long to keep deleted entity markers for sync (default: 7 days)</mat-hint>
      </mat-form-field>
    </div>

    <div class="card-footer">
      <button mat-button (click)="loadData()">
        <mat-icon>refresh</mat-icon>
        Reset
      </button>
      <button mat-raised-button color="primary" (click)="saveConfig()" [disabled]="saving">
        @if (saving) {
          Saving...
        } @else {
          Save Configuration
        }
      </button>
    </div>
  </mat-card>

  <!-- Status Card -->
  <mat-card class="content-card" *ngIf="status?.enabled">
    <div class="card-section">
      <div class="section-header">
        <h2>Sync Status</h2>
        <span class="status-badge active">Active</span>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <span class="label">Server ID</span>
          <span class="value monospace">{{ status?.server_id | slice:0:24 }}...</span>
        </div>
        <div class="info-item">
          <span class="label">Server Name</span>
          <span class="value">{{ status?.server_name || 'Not set' }}</span>
        </div>
        <div class="info-item">
          <span class="label">OpLog Entries</span>
          <span class="value">{{ status?.oplog_entries | number }}</span>
        </div>
        <div class="info-item">
          <span class="label">Current HLC</span>
          <span class="value monospace">{{ formatHLC(status?.current_hlc) }}</span>
        </div>
      </div>

      <button mat-stroked-button (click)="loadStatus()" class="action-btn">
        <mat-icon>refresh</mat-icon>
        Refresh Status
      </button>

      <button mat-raised-button color="accent" (click)="fullSync()" class="action-btn" matTooltip="Broadcast all local data to connected peers">
        <mat-icon>cloud_upload</mat-icon>
        Full Sync to Peers
      </button>
    </div>
  </mat-card>

  <!-- Peers Card -->
  <mat-card class="content-card" *ngIf="status?.enabled">
    <div class="card-section">
      <div class="section-header">
        <h2>Connected Peers</h2>
        <p class="section-desc">{{ status?.peers?.length || 0 }} peer(s) configured</p>
      </div>

      <div *ngIf="status?.peers?.length" class="peers-table-container">
        <table mat-table [dataSource]="status!.peers" class="peers-table">
          <ng-container matColumnDef="server_name">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let peer">{{ peer.server_name || 'Unknown' }}</td>
          </ng-container>

          <ng-container matColumnDef="server_id">
            <th mat-header-cell *matHeaderCellDef>Server ID</th>
            <td mat-cell *matCellDef="let peer">
              <span class="monospace">{{ peer.server_id | slice:0:16 }}...</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let peer">
              <span class="status-chip" [ngClass]="getStatusClass(peer)">
                <mat-icon class="status-icon">
                  {{ peer.connected ? 'check_circle' : (peer.last_error ? 'error' : 'cancel') }}
                </mat-icon>
                {{ getStatusText(peer) }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="last_sync">
            <th mat-header-cell *matHeaderCellDef>Last Sync</th>
            <td mat-cell *matCellDef="let peer">{{ formatTime(peer.last_sync_time) }}</td>
          </ng-container>

          <ng-container matColumnDef="pending_ops">
            <th mat-header-cell *matHeaderCellDef>Pending</th>
            <td mat-cell *matCellDef="let peer">
              <span [class.has-pending]="peer.pending_ops > 0">{{ peer.pending_ops | number }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let peer">
              <button mat-icon-button matTooltip="Force Sync" (click)="forceSync(peer)" [disabled]="!peer.connected">
                <mat-icon>sync</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.error-row]="row.last_error"></tr>
        </table>
      </div>

      <div *ngIf="!status?.peers?.length" class="empty-state">
        <mat-icon>link_off</mat-icon>
        <p>No peers connected</p>
        <p class="hint">Add peer servers in the configuration above</p>
      </div>
    </div>
  </mat-card>
</div>
