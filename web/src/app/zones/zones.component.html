<div class="zones-page">
  <div class="page-header">
    <h1>DNS Zones</h1>
    <div class="header-actions">
      <button class="btn btn-outline" (click)="openImportForm()">üì• Import Zone</button>
      <button class="btn btn-primary" (click)="openAddForm('forward')">+ Add Forward Zone</button>
      <button class="btn btn-secondary" (click)="openAddForm('reverse')">+ Add Reverse Zone</button>
      <button class="btn btn-secondary" (click)="openAddSecondaryForm()">+ Add Secondary Zone</button>
    </div>
  </div>

  <!-- Forward Zones Section -->
  <section class="zone-section">
    <h2>Forward Zones</h2>
    <div class="zones-table" *ngIf="forwardZones.length > 0">
      <table>
        <thead>
          <tr>
            <th>Zone Name</th>
            <th>TTL</th>
            <th>DNSSEC</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let zone of forwardZones">
            <td><code>{{ zone.name }}</code></td>
            <td>{{ zone.ttl }}s</td>
            <td>
              <span class="badge" [class.badge-success]="hasDnssec(zone.name)" [class.badge-muted]="!hasDnssec(zone.name)">
                {{ hasDnssec(zone.name) ? 'Enabled' : 'Disabled' }}
              </span>
              <button *ngIf="hasDnssec(zone.name)" class="btn btn-xs btn-link" (click)="viewDsRecord(zone.name)" title="View DS Record">üîë</button>
            </td>
            <td class="actions">
              <button class="btn btn-sm" (click)="openEditForm(zone)">Edit</button>
              <button class="btn btn-sm btn-danger" (click)="deleteZone(zone)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="forwardZones.length === 0" class="empty-state">
      <p>No forward zones configured.</p>
      <p>Add a forward zone (e.g., example.com) to manage DNS records.</p>
    </div>
  </section>

  <!-- Reverse Zones Section -->
  <section class="zone-section">
    <h2>Reverse Zones</h2>
    <div class="zones-table" *ngIf="reverseZones.length > 0">
      <table>
        <thead>
          <tr>
            <th>Zone Name</th>
            <th>Subnet</th>
            <th>Strip Prefix</th>
            <th>TTL</th>
            <th>DNSSEC</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let zone of reverseZones">
            <td><code>{{ zone.name }}</code></td>
            <td><code>{{ zone.subnet }}</code></td>
            <td>{{ zone.strip_prefix ? 'Yes' : 'No' }}</td>
            <td>{{ zone.ttl }}s</td>
            <td>
              <span class="badge" [class.badge-success]="hasDnssec(zone.name)" [class.badge-muted]="!hasDnssec(zone.name)">
                {{ hasDnssec(zone.name) ? 'Enabled' : 'Disabled' }}
              </span>
              <button *ngIf="hasDnssec(zone.name)" class="btn btn-xs btn-link" (click)="viewDsRecord(zone.name)" title="View DS Record">üîë</button>
            </td>
            <td class="actions">
              <button class="btn btn-sm" (click)="openEditForm(zone)">Edit</button>
              <button class="btn btn-sm btn-danger" (click)="deleteZone(zone)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="reverseZones.length === 0" class="empty-state">
      <p>No reverse DNS zones configured.</p>
      <p>Add a reverse zone to enable automatic PTR record generation for IP addresses.</p>
    </div>
  </section>

  <!-- Secondary Zones Section -->
  <section class="zone-section">
    <h2>Secondary Zones</h2>
    <p class="section-subtitle">Zones replicated from primary DNS servers</p>
    <div class="zones-table" *ngIf="secondaryZones.length > 0">
      <table>
        <thead>
          <tr>
            <th>Zone</th>
            <th>Primary Server</th>
            <th>Refresh Interval</th>
            <th>TSIG Key</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let zone of secondaryZones">
            <td><code>{{ zone.zone }}</code></td>
            <td><code>{{ zone.primary }}</code></td>
            <td>{{ zone.refresh_interval }}s</td>
            <td>
              <span class="badge" [class.badge-success]="zone.tsig_key" [class.badge-muted]="!zone.tsig_key">
                {{ zone.tsig_key ? 'Configured' : 'None' }}
              </span>
            </td>
            <td class="actions">
              <button class="btn btn-sm" (click)="triggerZoneTransfer(zone)" title="Trigger Transfer">üîÑ</button>
              <button class="btn btn-sm" (click)="openEditSecondaryForm(zone)">Edit</button>
              <button class="btn btn-sm btn-danger" (click)="deleteSecondaryZone(zone)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div *ngIf="secondaryZones.length === 0" class="empty-state">
      <p>No secondary zones configured.</p>
      <p>Add a secondary zone to replicate DNS data from a primary server.</p>
    </div>
  </section>

  <!-- Modal Form -->
  <div class="modal-backdrop" *ngIf="showForm" (click)="closeForm()"></div>
  <div class="modal" *ngIf="showForm">
    <div class="modal-header">
      <h2>{{ editingZone ? 'Edit Zone' : (formData.type === 'forward' ? 'Add Forward Zone' : 'Add Reverse Zone') }}</h2>
      <button class="close-btn" (click)="closeForm()">√ó</button>
    </div>
    <div class="modal-body">
      <!-- Common field: Zone Name (for forward zones) -->
      <div class="form-group" *ngIf="formData.type === 'forward'">
        <label for="name">Zone Name</label>
        <input type="text" id="name" [(ngModel)]="formData.name" 
               placeholder="e.g., example.com or home.local">
        <small>The domain name for this zone</small>
      </div>

      <!-- Reverse zone specific fields -->
      <ng-container *ngIf="formData.type === 'reverse'">
        <div class="form-group">
          <label for="subnet">Subnet (CIDR)</label>
          <input type="text" id="subnet" [(ngModel)]="formData.subnet" 
                 placeholder="e.g., 192.168.1.0/24 or 2001:db8::/32">
          <small>IPv4 or IPv6 subnet in CIDR notation</small>
        </div>

        <div class="form-group">
          <label for="domain">Domain (for PTR records)</label>
          <input type="text" id="domain" [(ngModel)]="formData.domain" 
                 placeholder="e.g., example.com">
          <small>The domain suffix for generated PTR hostnames (e.g., "host.example.com")</small>
        </div>

        <div class="form-group checkbox">
          <label>
            <input type="checkbox" [(ngModel)]="formData.strip_prefix">
            Strip subnet prefix from generated names
          </label>
          <small>For IPv6, removes the network prefix from hostnames</small>
        </div>
      </ng-container>

      <div class="form-group">
        <label for="ttl">TTL (seconds)</label>
        <input type="number" id="ttl" [(ngModel)]="formData.ttl" min="60">
      </div>

      <!-- DNSSEC Section -->
      <div class="dnssec-section">
        <h3>DNSSEC</h3>
        <div class="form-group checkbox">
          <label>
            <input type="checkbox" [(ngModel)]="dnssecEnabled">
            Enable DNSSEC signing
          </label>
          <small>Sign DNS responses with DNSSEC for improved security</small>
        </div>

        <div *ngIf="dnssecEnabled">
          <!-- KSK Rotation Advisory Warning -->
          <div class="ksk-warning" *ngIf="currentDnssec?.ksk_rotation_due">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-content">
              <strong>KSK Rotation Recommended</strong>
              <p>Your Key Signing Key is over 1 year old. Consider rotating it for improved security. 
                 Note: Rotating the KSK requires updating the DS record at your domain registrar.</p>
            </div>
          </div>

          <div class="form-group">
            <label for="algorithm">Algorithm</label>
            <select id="algorithm" [(ngModel)]="dnssecAlgorithm" [disabled]="currentDnssec?.enabled === true">
              <option *ngFor="let algo of algorithms" [value]="algo.value">{{ algo.label }}</option>
            </select>
            <small *ngIf="currentDnssec?.enabled">Algorithm cannot be changed after DNSSEC is enabled</small>
          </div>

          <!-- Show DS Record for existing DNSSEC zones -->
          <div class="ds-record-section" *ngIf="currentDnssec?.ds_record">
            <label>DS Record (add to your registrar)</label>
            <div class="ds-record-box">
              <code>{{ currentDnssec?.ds_record }}</code>
              <button class="btn btn-sm" (click)="copyDsRecord()" title="Copy">üìã</button>
            </div>
            <small>Key Tag: {{ currentDnssec?.ksk_key_tag }}</small>
          </div>

          <!-- Key Export/Import for Secondary Servers -->
          <div class="key-management-section" *ngIf="currentDnssec?.enabled">
            <label>Key Management</label>
            <div class="key-buttons">
              <button class="btn btn-sm" (click)="downloadKeys()" title="Download signing keys for secondary servers">
                ‚¨áÔ∏è Download Keys
              </button>
              <button class="btn btn-sm" (click)="triggerKeyUpload()" title="Upload keys from primary server">
                ‚¨ÜÔ∏è Upload Keys
              </button>
              <input #keyFileInput type="file" accept=".json" style="display: none" (change)="uploadKeys($event)">
            </div>
            <small>Export keys to share with secondary servers for signing dynamic records</small>

            <!-- Key Sharing Token for Automatic Sync -->
            <div class="key-token-section">
              <label>Key Sharing Token</label>
              <p class="token-description">Generate a token that secondary servers can use to automatically fetch DNSSEC keys.</p>
              
              <div *ngIf="!keyToken" class="token-actions">
                <button class="btn btn-sm" (click)="generateKeyToken()">üîë Generate Token</button>
              </div>

              <div *ngIf="keyToken" class="token-display">
                <div class="token-box">
                  <code>{{ showKeyToken ? keyToken : keyToken }}</code>
                  <button *ngIf="showKeyToken" class="btn btn-sm" (click)="copyKeyToken()" title="Copy Token">üìã</button>
                </div>
                <div *ngIf="showKeyToken" class="token-url">
                  <small>Key Fetch URL:</small>
                  <code class="url">{{ getKeyFetchUrl() }}</code>
                  <button class="btn btn-sm" (click)="copyKeyFetchUrl()" title="Copy URL">üìã</button>
                </div>
                <div class="token-actions">
                  <button class="btn btn-sm btn-danger" (click)="revokeKeyToken()">Revoke Token</button>
                  <button *ngIf="!showKeyToken" class="btn btn-sm" (click)="generateKeyToken()">Regenerate</button>
                </div>
                <small *ngIf="!showKeyToken">Token is masked. Regenerate to see the full token.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" (click)="closeForm()" [disabled]="saving">Cancel</button>
      <button class="btn btn-primary" (click)="saveZone()" [disabled]="saving">
        {{ saving ? 'Saving...' : 'Save' }}
      </button>
    </div>
  </div>
</div>

<!-- DS Record View Modal -->
<div class="modal-backdrop" *ngIf="showDsRecord" (click)="closeDsModal()"></div>
<div class="modal ds-modal" *ngIf="showDsRecord">
  <div class="modal-header">
    <h2>DS Record for {{ showDsRecord.zone }}</h2>
    <button class="close-btn" (click)="closeDsModal()">√ó</button>
  </div>
  <div class="modal-body">
    <p class="ds-intro">Add this DS record at your domain registrar to complete DNSSEC setup:</p>
    <div class="ds-record-box">
      <code>{{ showDsRecord.ds_record }}</code>
      <button class="btn btn-sm" (click)="copyDsRecordFromModal()" title="Copy">üìã Copy</button>
    </div>
    <div class="ds-details">
      <div class="detail-row">
        <span class="label">Algorithm:</span>
        <span class="value">{{ showDsRecord.algorithm }}</span>
      </div>
      <div class="detail-row">
        <span class="label">KSK Key Tag:</span>
        <span class="value">{{ showDsRecord.ksk_key_tag }}</span>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" (click)="closeDsModal()">Close</button>
  </div>
</div>

<!-- Secondary Zone Modal Form -->
<div class="modal-backdrop" *ngIf="showSecondaryForm" (click)="closeSecondaryForm()"></div>
<div class="modal" *ngIf="showSecondaryForm">
  <div class="modal-header">
    <h2>{{ editingSecondaryZone ? 'Edit' : 'Add' }} Secondary Zone</h2>
    <button class="close-btn" (click)="closeSecondaryForm()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="form-group">
      <label for="sec-zone">Zone Name</label>
      <input type="text" id="sec-zone" [(ngModel)]="secondaryFormData.zone" 
             placeholder="example.com" [disabled]="!!editingSecondaryZone">
      <small>The zone to replicate (e.g., example.com)</small>
    </div>

    <div class="form-group">
      <label for="sec-primary">Primary Server</label>
      <input type="text" id="sec-primary" [(ngModel)]="secondaryFormData.primary" 
             placeholder="192.168.1.1:53">
      <small>Address of the primary DNS server (IP:port)</small>
    </div>

    <div class="form-group">
      <label for="sec-refresh">Refresh Interval (seconds)</label>
      <input type="number" id="sec-refresh" [(ngModel)]="secondaryFormData.refresh_interval" min="60">
      <small>How often to check for zone updates</small>
    </div>

    <div class="form-group">
      <label for="sec-tsig">TSIG Key Name (optional)</label>
      <input type="text" id="sec-tsig" [(ngModel)]="secondaryFormData.tsig_key" 
             placeholder="transfer-key">
      <small>Name of the TSIG key for authenticated transfers</small>
    </div>

    <div class="dnssec-section">
      <h3>DNSSEC Key Sharing</h3>
      <p class="section-description">
        For reverse zones with dynamic records (like IPv6 PTR), import DNSSEC keys from the primary server
        to sign records locally on this secondary.
      </p>

      <div class="form-group">
        <label for="sec-key-url">DNSSEC Key URL (optional)</label>
        <input type="text" id="sec-key-url" [(ngModel)]="secondaryFormData.dnssec_key_url" 
               placeholder="https://primary.example.com/api/dnssec/keys/zone">
        <small>URL to fetch DNSSEC keys from primary server</small>
      </div>

      <div class="form-group">
        <label for="sec-key-token">DNSSEC Key Token (optional)</label>
        <input type="password" id="sec-key-token" [(ngModel)]="secondaryFormData.dnssec_key_token" 
               placeholder="Bearer token">
        <small>Authentication token for key retrieval</small>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" (click)="closeSecondaryForm()">Cancel</button>
    <button class="btn btn-primary" (click)="saveSecondaryZone()">Save</button>
  </div>
</div>

<!-- Zone Import Modal -->
<div class="modal import-modal" *ngIf="showImportForm">
  <div class="modal-header">
    <h2>Import Zone from Zone File</h2>
    <button class="close-btn" (click)="closeImportForm()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="import-intro" *ngIf="!importPreview">
      <p>
        Import a DNS zone from a <strong>BIND zone file</strong>. This format is supported by most DNS providers
        including GoDaddy, AWS Route53, Azure DNS, Cloudflare, and others.
      </p>
      
      <div class="provider-help">
        <h4>How to export from your current provider:</h4>
        <ul>
          <li><strong>GoDaddy:</strong> DNS ‚Üí Zone File ‚Üí Export</li>
          <li><strong>AWS Route53:</strong> Hosted Zone ‚Üí Export to BIND format</li>
          <li><strong>Azure DNS:</strong> Export zone file from the portal or CLI</li>
          <li><strong>Cloudflare:</strong> DNS ‚Üí Advanced ‚Üí Export DNS Records</li>
        </ul>
      </div>
    </div>

    <div class="form-group">
      <label for="import-zone-name">Zone Name</label>
      <input type="text" id="import-zone-name" [(ngModel)]="importFormData.zoneName" 
             placeholder="example.com" [disabled]="!!importPreview">
      <small>The domain name for this zone (e.g., example.com)</small>
    </div>

    <div class="form-group" *ngIf="!importPreview">
      <label for="import-file">Zone File</label>
      <div class="file-upload">
        <input type="file" id="import-file" #fileInput (change)="onFileSelected($event)" accept=".txt,.zone,.db">
        <button class="btn btn-sm" (click)="fileInput.click()">Choose File</button>
        <span class="file-name">{{ selectedFileName || 'No file selected' }}</span>
      </div>
      <small>Upload a BIND zone file (.txt, .zone, or .db)</small>
    </div>

    <div class="form-group" *ngIf="!importPreview">
      <label for="import-content">Or paste zone file content</label>
      <textarea id="import-content" [(ngModel)]="importFormData.zoneFile" rows="10"
                placeholder="$TTL 3600
@       IN      SOA     ns1.example.com. admin.example.com. (
                        2024010101      ; Serial
                        3600            ; Refresh
                        600             ; Retry
                        604800          ; Expire
                        3600 )          ; Minimum TTL

@       IN      NS      ns1.example.com.
@       IN      NS      ns2.example.com.
@       IN      A       192.168.1.1
www     IN      A       192.168.1.2
mail    IN      MX  10  mail.example.com."></textarea>
    </div>

    <!-- Preview Section -->
    <div class="import-preview" *ngIf="importPreview">
      <h3>Preview Import</h3>
      
      <div class="preview-summary">
        <div class="summary-item">
          <strong>Zone:</strong> {{ importPreview.zone?.name }}
        </div>
        <div class="summary-item">
          <strong>Records:</strong> {{ importPreview.record_count }}
        </div>
        <div class="summary-item" *ngIf="importPreview.zone?.ttl">
          <strong>Default TTL:</strong> {{ importPreview.zone?.ttl }}s
        </div>
      </div>

      <div class="preview-warnings" *ngIf="importPreview.warnings?.length">
        <h4>‚ö†Ô∏è Warnings</h4>
        <ul>
          <li *ngFor="let warning of importPreview.warnings">{{ warning }}</li>
        </ul>
      </div>

      <div class="preview-errors" *ngIf="importPreview.errors?.length">
        <h4>‚ùå Errors (these records will be skipped)</h4>
        <ul>
          <li *ngFor="let error of importPreview.errors">{{ error }}</li>
        </ul>
      </div>

      <div class="preview-records">
        <h4>Records to Import</h4>
        <table class="preview-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>TTL</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of importPreview.records" [class.soa-record]="record.type === 'SOA'">
              <td><code>{{ record.name }}</code></td>
              <td><span class="record-type">{{ record.type }}</span></td>
              <td>{{ record.ttl }}s</td>
              <td><code>{{ record.raw_data || (record.data | json) }}</code></td>
            </tr>
          </tbody>
        </table>
        <p class="record-note" *ngIf="hasSoaRecord()">
          <em>SOA records are used for zone configuration and won't be imported as separate records.</em>
        </p>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" (click)="closeImportForm()">Cancel</button>
    <button class="btn btn-secondary" *ngIf="importPreview" (click)="importPreview = null">‚Üê Back</button>
    <button class="btn btn-primary" *ngIf="!importPreview" (click)="previewImport()" 
            [disabled]="!importFormData.zoneName || !importFormData.zoneFile || importLoading">
      {{ importLoading ? 'Analyzing...' : 'Preview Import' }}
    </button>
    <button class="btn btn-primary" *ngIf="importPreview" (click)="executeImport()" 
            [disabled]="importLoading">
      {{ importLoading ? 'Importing...' : 'Import Zone' }}
    </button>
  </div>
</div>
